{% extends 'base-super_admin.html.twig' %}

{% block header %}
    {{ 'adm.evenement.modification.heading'|trans({}, 'evenement') }}
{% endblock %}

{% block headeractions %}
    <div class="header-action">
        {{ include('composants/sadm-buttons-edit.html.twig', {elt:'evenement', id: evenement.id}) }}
    </div>
{% endblock %}

{% block content %}
    <div class="card">
        <h4 class="card-title">{{ 'adm.evenement.modification.heading'|trans({}, 'evenement') }}</h4>
        <div class="card-body">
            <div class="mb-3">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEtudiants">
                    {{ 'adm.evenement.form.ouvrir_selection_etudiants'|trans({}, 'evenement') }}
                </button>
                <div id="evenement-selected-summary" class="mt-2">
                    {% for ee in evenement.etudiantEvenements %}
                        {% set e = ee.etudiant %}
                        <span class="badge bg-primary me-1 mb-1">{{ e.nom }} {{ e.prenom }}</span>
                    {% endfor %}
                </div>
            </div>

            {# Rendu du formulaire (édition) avec champs d'adresse autocomplétés #}
            {% form_theme form 'bootstrap_5_layout.html.twig' %}
            {{ form_start(form) }}

            <div class="mb-3">
                {{ form_row(form.libelle) }}
                {{ form_row(form.date) }}
                {{ form_row(form.debut) }}
                {{ form_row(form.fin) }}
            </div>

            <div class="form-group-adresse">
                <label for="adresseEvenement" class="form-label">Adresse de l'événement :</label>
                {# Valeur pré-remplie en toute sécurité depuis l'array evenement.adresse #}
                <input type="text" id="adresseEvenement" class="form-control" autocomplete="off" value="{{ evenement.adresse is defined and evenement.adresse is iterable ? (evenement.adresse['adresse1']|default('')) : '' }}">
                <div class="form-text mb-0 help-text">Veuillez saisir l'adresse puis sélectionner la proposition correspondante</div>

                <ul id="adresselisteEvenement"></ul>

                <hr>

                <div class="form-champs-adresse">
                    {{ form_row(form.adresse.adresse1) }}
                    {{ form_row(form.adresse.adresse2) }}
                    {{ form_row(form.adresse.adresse3) }}
                    {{ form_row(form.adresse.code_postal) }}
                    {{ form_row(form.adresse.ville) }}
                </div>
            </div>

            <div class="mb-3">
                {{ form_row(form.description) }}
                {{ form_row(form.geoloc) }}
            </div>

            {{ form_widget(form.etudiants) }}
            {{ form_widget(form.etudiantsIds) }}

            <button class="btn btn-success" value="redirect_to_index" name="btn_update"><i class="fas fa-floppy-disk-circle-arrow-right"></i> {{ 'button_update_index'|trans }}</button>

            {{ form_end(form) }}

        </div>
    </div>

    {# Modal de sélection des étudiants #}
    {{ include('super-administration/evenement/_modal_etudiants.html.twig') }}

    {# Pré-remplir le hidden avec les étudiants déjà sélectionnés (construction sûre côté serveur/Twig) #}
    {% set _ids = [] %}
    {% for ee in evenement.etudiantEvenements %}
        {% set _ids = _ids|merge([ee.etudiant.id]) %}
    {% endfor %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.querySelector('input[name="evenement[etudiantsIds]"]');
            if (input && !input.value) {
                const ids = {{ _ids|json_encode()|raw }};
                input.value = ids.join(',');
            }
        });
    </script>

    <script defer>
      window.addEventListener('load', () => {
        // Pré-remplissage des champs d'adresse à partir de evenement.adresse si présent
        try {
          const addr = {{ evenement.adresse ? evenement.adresse|json_encode(constant('JSON_HEX_TAG')) : 'null' }};
          if (addr) {
            if (addr.adresse1 !== undefined) document.getElementById('evenement_adresse_adresse1').value = addr.adresse1;
            if (addr.adresse2 !== undefined) document.getElementById('evenement_adresse_adresse2').value = addr.adresse2;
            if (addr.adresse3 !== undefined) document.getElementById('evenement_adresse_adresse3').value = addr.adresse3;
            if (addr.codePostal !== undefined) document.getElementById('evenement_adresse_code_postal').value = addr.codePostal;
            if (addr.ville !== undefined) {
              const villeSelect = document.getElementById('evenement_adresse_ville');
              villeSelect.innerHTML = '';
              const opt = document.createElement('option'); opt.text = addr.ville; opt.value = addr.ville; villeSelect.append(opt);
            }
          }
        } catch (e) {
          // ignore
        }

      })
    </script>

    {# Included reusable autocomplete script #}
    {{ include('super-administration/evenement/_adresse_autocomplete.html.twig') }}

{% endblock %}
